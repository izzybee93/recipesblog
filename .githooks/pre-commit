#!/bin/sh

# Process recipe files and images before commit

# Process recipe MDX files - replace fractions with Unicode characters
echo "üìù Processing recipe files..."

RECIPES=$(git diff --cached --name-only --diff-filter=ACM | grep "^content/recipes/.*\.mdx$")

if [ ! -z "$RECIPES" ]; then
  for RECIPE in $RECIPES; do
    echo "Processing fractions in: $RECIPE"
    
    # Replace common fractions with Unicode equivalents and add degree symbols
    # Using sed with in-place editing
    sed -i '' \
      -e 's/1\/4/¬º/g' \
      -e 's/1\/2/¬Ω/g' \
      -e 's/3\/4/¬æ/g' \
      -e 's/1\/3/‚Öì/g' \
      -e 's/2\/3/‚Öî/g' \
      -e 's/1\/8/‚Öõ/g' \
      -e 's/3\/8/‚Öú/g' \
      -e 's/5\/8/‚Öù/g' \
      -e 's/7\/8/‚Öû/g' \
      -e 's/1\/5/‚Öï/g' \
      -e 's/2\/5/‚Öñ/g' \
      -e 's/3\/5/‚Öó/g' \
      -e 's/4\/5/‚Öò/g' \
      -e 's/1\/6/‚Öô/g' \
      -e 's/5\/6/‚Öö/g' \
      -e 's/\([0-9]\{1,3\}\)C/\1¬∞C/g' \
      -e 's/\([0-9]\{1,3\}\)F/\1¬∞F/g' \
      "$RECIPE"
    
    # Re-add the processed file to git
    git add "$RECIPE"
  done
  echo "‚úÖ Recipe fractions converted successfully!"
fi

# Process recipe images - strip metadata and resize if needed
echo "üñºÔ∏è Processing recipe images..."

IMAGES=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/images/recipes/.*\.\(jpg\|jpeg\|png\)$")

if [ ! -z "$IMAGES" ]; then
  for IMAGE in $IMAGES; do
    echo "Processing: $IMAGE"

    # Strip metadata using exiftool (same as your chop command)
    exiftool "-gps*=" "$IMAGE" -overwrite_original 2>/dev/null

    # Check size and resize if needed
    SIZE=$(stat -f%z "$IMAGE" 2>/dev/null || stat -c%s "$IMAGE" 2>/dev/null)
    if [ "$SIZE" -gt 1048576 ]; then
      ORIGINAL_SIZE=$(ls -lh "$IMAGE" | awk '{print $5}')
      echo "‚ö†Ô∏è  Image is $ORIGINAL_SIZE, resizing to be under 1MB..."

      # Check if ImageMagick is installed
      if ! command -v magick &> /dev/null; then
        echo "‚ùå Error: ImageMagick (magick command) is not installed."
        echo "   Please install ImageMagick: brew install imagemagick"
        exit 1
      fi

      # Keep resizing by 50% until under 1MB
      while true; do
        SIZE=$(stat -f%z "$IMAGE" 2>/dev/null || stat -c%s "$IMAGE" 2>/dev/null)
        if [ "$SIZE" -le 1048576 ]; then
          break
        fi
        magick "$IMAGE" -resize 50% "$IMAGE"
      done

      NEW_SIZE=$(ls -lh "$IMAGE" | awk '{print $5}')
      echo "   ‚úÖ Resized to: $NEW_SIZE"
    fi

    # Re-add the processed file to git
    git add "$IMAGE"
  done
  echo "‚úÖ Recipe images processed successfully!"
fi

# Upload recipe images to Vercel Blob Storage
echo ""
echo "‚òÅÔ∏è  Uploading recipe images to Blob Storage..."

# Check if there are any recipe images to upload
if [ -d "public/images/recipes" ]; then
  IMAGE_COUNT=$(find public/images/recipes -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" \) 2>/dev/null | wc -l | tr -d ' ')

  if [ "$IMAGE_COUNT" -gt 0 ]; then
    # Load BLOB_READ_WRITE_TOKEN from .env.local (secure - not hardcoded!)
    if [ -f ".env.local" ]; then
      export $(grep "^BLOB_READ_WRITE_TOKEN=" .env.local | xargs)
    fi

    # Check if token is available
    if [ -z "$BLOB_READ_WRITE_TOKEN" ]; then
      echo "‚ö†Ô∏è  Warning: BLOB_READ_WRITE_TOKEN not found in .env.local"
      echo "   Recipe images will not be uploaded to Blob Storage"
      echo "   Run manually: npm run upload-recipe-images"
      echo ""
    else
      # Run upload script
      echo "   Found $IMAGE_COUNT local recipe images"
      npm run upload-recipe-images --silent

      if [ $? -eq 0 ]; then
        echo "‚úÖ Recipe images uploaded to Blob Storage"
      else
        echo "‚ö†Ô∏è  Warning: Some images may not have uploaded"
        echo "   Check output above for details"
      fi
    fi
  else
    echo "   No recipe images found to upload"
  fi
else
  echo "   Recipe images directory not found"
fi

echo ""
exit 0