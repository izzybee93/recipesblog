#!/bin/sh

# Process recipe files and images before commit

# Process recipe MDX files - replace fractions with Unicode characters
echo "ðŸ“ Processing recipe files..."

RECIPES=$(git diff --cached --name-only --diff-filter=ACM | grep "^content/recipes/.*\.mdx$")

if [ ! -z "$RECIPES" ]; then
  for RECIPE in $RECIPES; do
    echo "Processing fractions in: $RECIPE"
    
    # Replace common fractions with Unicode equivalents and add degree symbols
    # Using sed with in-place editing
    sed -i '' \
      -e 's/1\/4/Â¼/g' \
      -e 's/1\/2/Â½/g' \
      -e 's/3\/4/Â¾/g' \
      -e 's/1\/3/â…“/g' \
      -e 's/2\/3/â…”/g' \
      -e 's/1\/8/â…›/g' \
      -e 's/3\/8/â…œ/g' \
      -e 's/5\/8/â…/g' \
      -e 's/7\/8/â…ž/g' \
      -e 's/1\/5/â…•/g' \
      -e 's/2\/5/â…–/g' \
      -e 's/3\/5/â…—/g' \
      -e 's/4\/5/â…˜/g' \
      -e 's/1\/6/â…™/g' \
      -e 's/5\/6/â…š/g' \
      -e 's/\([0-9]\{1,3\}\)C/\1Â°C/g' \
      -e 's/\([0-9]\{1,3\}\)F/\1Â°F/g' \
      "$RECIPE"
    
    # Re-add the processed file to git
    git add "$RECIPE"
  done
  echo "âœ… Recipe fractions converted successfully!"
fi

# Process recipe images - strip metadata and resize if needed
echo "ðŸ–¼ï¸ Processing recipe images..."

IMAGES=$(git diff --cached --name-only --diff-filter=ACM | grep "^public/images/recipes/.*\.\(jpg\|jpeg\|png\)$")

if [ ! -z "$IMAGES" ]; then
  for IMAGE in $IMAGES; do
    echo "Processing: $IMAGE"

    # Strip metadata using exiftool (same as your chop command)
    exiftool "-gps*=" "$IMAGE" -overwrite_original 2>/dev/null

    # Check size and resize if needed
    SIZE=$(stat -f%z "$IMAGE" 2>/dev/null || stat -c%s "$IMAGE" 2>/dev/null)
    if [ "$SIZE" -gt 1048576 ]; then
      ORIGINAL_SIZE=$(ls -lh "$IMAGE" | awk '{print $5}')
      echo "âš ï¸  Image is $ORIGINAL_SIZE, resizing to be under 1MB..."

      # Check if ImageMagick is installed
      if ! command -v magick &> /dev/null; then
        echo "âŒ Error: ImageMagick (magick command) is not installed."
        echo "   Please install ImageMagick: brew install imagemagick"
        exit 1
      fi

      # Keep resizing by 50% until under 1MB
      while true; do
        SIZE=$(stat -f%z "$IMAGE" 2>/dev/null || stat -c%s "$IMAGE" 2>/dev/null)
        if [ "$SIZE" -le 1048576 ]; then
          break
        fi
        magick "$IMAGE" -resize 50% "$IMAGE"
      done

      NEW_SIZE=$(ls -lh "$IMAGE" | awk '{print $5}')
      echo "   âœ… Resized to: $NEW_SIZE"
    fi

    # Re-add the processed file to git
    git add "$IMAGE"
  done
  echo "âœ… Recipe images processed successfully!"
fi

exit 0